<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSVå·®åˆ†ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --accent:#22d3ee; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, "Apple Color Emoji"; background: radial-gradient(1200px 800px at 70% -10%, #111827, #0b1222), var(--bg); color: var(--text); }
    header { padding: 18px 20px; border-bottom: 1px solid #1f2937; position: sticky; top:0; backdrop-filter: blur(6px); background: rgba(15,23,42,0.7); z-index:5; }
    header h1 { margin:0; font-size: 18px; letter-spacing: .03em; }
    main { max-width: 1200px; margin: 24px auto 80px; padding: 0 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 960px){ .row { grid-template-columns: 420px 1fr; } }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); border: 1px solid #1f2937; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04); }

    .dropzone { border: 2px dashed #334155; border-radius: 14px; padding: 18px; text-align: center; transition: .2s border-color, .2s background; background: #0b1220; }
    .dropzone.dragover { border-color: var(--accent); background: rgba(34,211,238,0.08); }
    .muted { color: #94a3b8; font-size: 13px; }
    .control { display:flex; align-items:center; gap:8px; margin: 8px 0; }
    .control label { font-size: 14px; color:#cbd5e1; }

    .btn { background: linear-gradient(180deg, #1f2937, #111827); border: 1px solid #334155; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor:pointer; font-weight:600; letter-spacing:.02em; }
    .btn:hover { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(34,211,238,0.12); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .filelist { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .fileitem { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid #253144; border-radius:10px; background:#0b1220; }
    .fileitem small { color:#94a3b8; }

    .bad { color: var(--bad); }
    .good { color: var(--good); }
    .warn { color: var(--warn); }

    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid #334155; background:#0b1220; font-size:12px; }

    table { width:100%; border-collapse: collapse; overflow: auto; }
    thead th { position: sticky; top: 0; background:#0b1220; z-index:1; }
    th, td { border-bottom: 1px solid #1f2937; padding: 8px 10px; text-align: left; vertical-align: top; font-size: 13px; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; }

    .footer { margin-top: 10px; display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; border:1px solid #334155; background:#0b1220; padding:2px 6px; border-radius:6px; font-size:12px; color:#cbd5e1; }

    details { border:1px solid #253144; border-radius: 12px; padding: 10px 12px; background:#0b1220; }
    details summary { cursor: pointer; user-select: none; }

    .grid-2 { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 840px){ .grid-2 { grid-template-columns: 1fr 1fr; } }

    select.btn { padding-right:28px; }
  </style>
</head>
<body>
  <header>
    <h1>CSVå·®åˆ†ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆé †ä¸åŒä¸€è‡´ãƒ»éƒ¨åˆ†çš„æ¤œæŸ»ãƒ»ã‚«ãƒ©ãƒ å¯¾å¿œãƒ»ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼‰</h1>
  </header>
  <main>
    <div class="row">
      <section class="card">
        <h2 style="margin-top:0">1) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶</h2>
        <div id="dropzone" class="dropzone">
          <p style="margin:6px 0 2px">ã“ã“ã« <b>CSV</b> ã‚’<span class="muted">ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>ï¼ˆ2å€‹ä»¥ä¸Šï¼‰</p>
          <p class="muted" style="margin:0">ã¾ãŸã¯</p>
          <p style="margin:8px 0 0"><label class="btn">CSVã‚’é¸æŠ<input id="fileInput" type="file" accept=".csv,text/csv" multiple hidden></label></p>
        </div>
        <div class="control"><input type="checkbox" id="skipHeader"><label for="skipHeader">1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ <b>æ¯”è¼ƒã‹ã‚‰é™¤å¤–</b>ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«1è¡Œç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰</label></div>
        <div class="control"><input type="checkbox" id="trimCells" checked><label for="trimCells">ã‚»ãƒ«å‰å¾Œã®ç©ºç™½ã‚’ãƒˆãƒªãƒ </label></div>
        <div class="control"><input type="checkbox" id="treatAsMultiset" checked><label for="treatAsMultiset">é‡è¤‡è¡Œã® <b>å€‹æ•°</b>ã‚‚æ¯”è¼ƒï¼ˆå¤šé‡é›†åˆã¨ã—ã¦ä¸€è‡´ã‚’åˆ¤å®šï¼‰</label></div>
        <div class="filelist" id="fileList"></div>
        <div class="footer muted">
          <span class="kbd">âŒ˜/Ctrl</span> + <span class="kbd">A</span> ã§è¤‡æ•°é¸æŠ / å¤§ããªCSVã¯æ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™
        </div>
      </section>

      <section class="card">
        <h2 style="margin-top:0">2) è§£æçµæœ</h2>
        <div id="summary" class="muted">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿æ¬¡ç¬¬ã€ã“ã“ã«çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="analyzeBtn" class="btn" disabled>è§£æã™ã‚‹</button>
          <button id="clearBtn" class="btn" style="background:linear-gradient(180deg,#3f1f1f,#241313); border-color:#4b2b2b;" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="exportBtn" class="btn" disabled>ä¸ä¸€è‡´è¡Œã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>
      </section>
    </div>

    <!-- 3) ã‚«ãƒ©ãƒ å¯¾å¿œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä¸ä¸€è‡´æ™‚ï¼‰ -->
    <section class="card" id="colmapCard" style="margin-top:16px; display:none">
      <h3 style="margin-top:0">3) ã‚«ãƒ©ãƒ å¯¾å¿œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä¸ä¸€è‡´æ™‚ã®å†æ¤œæŸ»ï¼‰</h3>
      <p class="muted" style="margin-top:0">
        ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1è¡Œç›®ï¼‰ã®ã‚«ãƒ©ãƒ åãŒãƒ•ã‚¡ã‚¤ãƒ«é–“ã§ä¸€è‡´ã—ãªã„ãŸã‚ã€<b>å¯¾å¿œé–¢ä¿‚</b>ã‚’æ‰‹å‹•æŒ‡å®šã—ã¦å†æ¤œæŸ»ã§ãã¾ã™ã€‚<br>
        â€»ã€Œ1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦æ¯”è¼ƒã‹ã‚‰é™¤å¤–ã€ãŒONã®å ´åˆã€ã“ã®æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
      </p>
      <div id="colmapContainer" style="display:grid; gap:12px"></div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="applyMappingBtn" class="btn">å¯¾å¿œã‚’é©ç”¨ã—ã¦å†æ¤œæŸ»</button>
      </div>
    </section>

    <!-- 4) éƒ¨åˆ†çš„ãªæ¤œæŸ»ï¼ˆã‚­ãƒ¼ã‚«ãƒ©ãƒ çªåˆ & æ¯”è¼ƒã‚«ãƒ©ãƒ å¯¾å¿œï¼‰ -->
    <section class="card" id="partialCard" style="margin-top:16px; display:none">
      <h3 style="margin-top:0">4) éƒ¨åˆ†çš„ãªæ¤œæŸ»ï¼ˆä¾‹ï¼šindex ã¨ votes/raw_votes ã®ä¸€è‡´ï¼‰</h3>
      <p class="muted" style="margin-top:0">
        å…ˆé ­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’<b>åŸºæº–</b>ã¨ã—ã¦ã€åŒã˜ã‚­ãƒ¼ï¼ˆä¾‹ï¼š<code>index</code>ï¼‰ã§è¡Œã‚’çªåˆã—ã€é¸æŠã—ãŸã€Œæ¯”è¼ƒã‚«ãƒ©ãƒ ã€ï¼ˆä¾‹ï¼š<code>raw_votes</code> ã¨ <code>votes</code>ï¼‰ã®å€¤ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹æ¤œæŸ»ã—ã¾ã™ã€‚<br>
        ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ1è¡Œç›®ï¼‰ãŒå¿…è¦ã§ã™ã€‚â€»ã€Œãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–ã€ã‚’ONã«ã—ã¦ã„ã‚‹ã¨ä½¿ãˆã¾ã›ã‚“ã€‚
      </p>
      <div id="partialConfig" class="grid-2"></div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <label class="control" style="margin:0">
          <input type="checkbox" id="partialTrim" checked>
          <span>æ¯”è¼ƒæ™‚ã«å‰å¾Œç©ºç™½ã‚’ãƒˆãƒªãƒ </span>
        </label>
        <label class="control" style="margin:0">
          <input type="checkbox" id="partialStrict" checked>
          <span>å³å¯†ä¸€è‡´ï¼ˆæ–‡å­—åˆ—å®Œå…¨ä¸€è‡´ï¼‰</span>
        </label>
        <button id="runPartialBtn" class="btn">éƒ¨åˆ†çš„æ¤œæŸ»ã‚’å®Ÿè¡Œ</button>
      </div>
      <div id="partialResult" style="margin-top:12px" class="muted">è¨­å®šå¾Œã«ã€Œéƒ¨åˆ†çš„æ¤œæŸ»ã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3 style="margin-top:0">è©³ç´°ï¼ˆä¸ä¸€è‡´è¡Œ ä¸€è¦§ï¼‰</h3>
      <div id="detailsWrap" class="muted">ä¸ä¸€è‡´ãŒã‚ã‚‹å ´åˆã€ã“ã®ä¸‹ã« <b>è¡Œãã®ã‚‚ã®</b> ã¨ <b>å„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®å‡ºç¾å›æ•°</b> ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚</div>
    </section>

    <section class="card" style="margin-top:16px">
      <details>
        <summary>ä½¿ã„æ–¹ / ä»•æ§˜</summary>
        <ul>
          <li>2å€‹ä»¥ä¸Šã®CSVã«å¯¾å¿œã€‚<b>è¡Œã®é †åºã¯ç„¡è¦–</b>ã—ã¾ã™ã€‚</li>
          <li>ã€Œé‡è¤‡è¡Œã®å€‹æ•°ã‚‚æ¯”è¼ƒã€ã‚’ONã®å ´åˆã€å¤šé‡é›†åˆã¨ã—ã¦ä¸€è‡´ï¼ˆå„è¡Œã®å‡ºç¾å›æ•°ãŒå…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§åŒã˜ï¼‰ã‚’åˆ¤å®šã€‚OFFã®å ´åˆã¯é›†åˆæ¯”è¼ƒï¼ˆå­˜åœ¨æœ‰ç„¡ã®ã¿ï¼‰ã€‚</li>
          <li>ã‚µã‚¤ã‚ºä¸€è‡´ã¯ã€Œ<b>ç·è¡Œæ•°</b>ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–è¨­å®šå¾Œï¼‰ã€ã€Œåˆ—æ•°ï¼ˆå„è¡Œã®æœ€å¤§åˆ—æ•°ï¼‰ã€ã‚’å‚è€ƒã«æ¯”è¼ƒã—ã¾ã™ã€‚</li>
          <li>éƒ¨åˆ†ä¸€è‡´ã‚’é›†è¨ˆã—ã€<b>ä¸€è‡´ã—ã¦ã„ãªã„è¡Œã‚’ã™ã¹ã¦</b>è¡¨ã¨ã—ã¦å‡ºåŠ›ã—ã¾ã™ï¼ˆå„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºç¾å›æ•°ã‚‚ä½µè¨˜ï¼‰ã€‚</li>
          <li>ãƒ˜ãƒƒãƒ€ãƒ¼ä¸ä¸€è‡´æ™‚ã¯<b>æ‰‹å‹•ã‚«ãƒ©ãƒ å¯¾å¿œ</b>ãŒå¯èƒ½ã€‚ã•ã‚‰ã«<b>éƒ¨åˆ†çš„ãªæ¤œæŸ»</b>ã§ã€ä»»æ„ã®ã‚­ãƒ¼ï¼†æ¯”è¼ƒã‚«ãƒ©ãƒ ã®ä¸€è‡´ã‚’æ¤œæŸ»å¯èƒ½ã§ã™ã€‚</li>
          <li>CSVãƒ‘ãƒ¼ã‚¹ã¯ <a href="https://www.papaparse.com/" target="_blank" rel="noreferrer">Papa Parse</a> ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆRFC4180æº–æ‹ ï¼‰ã€‚</li>
        </ul>
      </details>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const fileList = document.getElementById('fileList');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const summary = document.getElementById('summary');
    const detailsWrap = document.getElementById('detailsWrap');
    const skipHeader = document.getElementById('skipHeader');
    const trimCells = document.getElementById('trimCells');
    const treatAsMultiset = document.getElementById('treatAsMultiset');

    const colmapCard = document.getElementById('colmapCard');
    const colmapContainer = document.getElementById('colmapContainer');
    const applyMappingBtn = document.getElementById('applyMappingBtn');

    const partialCard = document.getElementById('partialCard');
    const partialConfig = document.getElementById('partialConfig');
    const partialResult = document.getElementById('partialResult');
    const partialTrim = document.getElementById('partialTrim');
    const partialStrict = document.getElementById('partialStrict');
    const runPartialBtn = document.getElementById('runPartialBtn');

    /** @type {File[]} */
    let files = [];
    /** headers and raw rows **/
    let headersPerFile = [];
    let rawRowsPerFile = [];

    /** column mapping state for header alignment **/
    let columnMappings = {}; // fileIndex -> [sourceIdx per canonical order]
    let mappingActive = false;

    let lastReport = null;

    // ---------- Utils ----------
    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }
    function csvEscape(s){
      const t = String(s);
      if (/[",\n]/.test(t)) return '"' + t.replace(/"/g, '""') + '"';
      return t;
    }
    function norm(s, trim){ return trim ? String(s).trim() : String(s); }
    const fmt = (n)=> new Intl.NumberFormat('ja-JP').format(n);

    // ---------- File UI ----------
    function refreshList(){
      fileList.innerHTML = '';
      files.forEach((f, idx) => {
        const div = document.createElement('div');
        div.className = 'fileitem';
        const name = document.createElement('div');
        name.innerHTML = `<b>${escapeHtml(f.name)}</b><br><small>${(f.size/1024).toFixed(1)} KB</small>`;
        const del = document.createElement('button');
        del.className = 'btn';
        del.textContent = 'å‰Šé™¤';
        del.addEventListener('click', ()=>{ files.splice(idx,1); onFilesChanged(); });
        div.appendChild(name); div.appendChild(del);
        fileList.appendChild(div);
      });
    }

    function onFilesChanged(){
      refreshList();
      analyzeBtn.disabled = files.length < 2;
      clearBtn.disabled = files.length === 0;
      exportBtn.disabled = true;
      summary.innerHTML = files.length < 2 ? '<span class="muted">CSVã‚’2å€‹ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚</span>' : '<span class="muted">æº–å‚™OKã€‚ã€Œè§£æã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>';
      detailsWrap.innerHTML = '<span class="muted">ä¸ä¸€è‡´ãŒã‚ã‚‹å ´åˆã€ã“ã“ã«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>';
      headersPerFile = [];
      rawRowsPerFile = [];
      columnMappings = {};
      mappingActive = false;
      colmapCard.style.display = 'none';
      colmapContainer.innerHTML = '';
      partialCard.style.display = 'none';
      partialConfig.innerHTML = '';
      partialResult.textContent = 'è¨­å®šå¾Œã«ã€Œéƒ¨åˆ†çš„æ¤œæŸ»ã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
    }

    fileInput.addEventListener('change', (e)=>{
      files = files.concat(Array.from(e.target.files || []));
      onFilesChanged();
      fileInput.value = '';
    });

    ;['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); }));
    dropzone.addEventListener('drop', (e)=>{
      const dropped = Array.from(e.dataTransfer.files || []).filter(f=>/\.csv$/i.test(f.name) || /text\//.test(f.type));
      files = files.concat(dropped);
      onFilesChanged();
    });

    clearBtn.addEventListener('click', ()=>{ files = []; onFilesChanged(); });

    skipHeader.addEventListener('change', ()=>{
      if (skipHeader.checked){
        // ãƒ˜ãƒƒãƒ€ãƒ¼/éƒ¨åˆ†æ¤œæŸ»ã¯ç„¡åŠ¹
        colmapCard.style.display = 'none';
        colmapContainer.innerHTML = '';
        mappingActive = false;
        columnMappings = {};
        partialCard.style.display = 'none';
      }
    });

    // ---------- Core ----------
    analyzeBtn.addEventListener('click', async ()=>{
      summary.innerHTML = 'è§£æä¸­â€¦';
      try {
        const parsed = await Promise.all(files.map(f => parseCsvFile(f)));
        rawRowsPerFile = parsed.map(x=>x);
        const cfg = { skipHeader: skipHeader.checked, trim: trimCells.checked, multiset: treatAsMultiset.checked };

        // æŠ½å‡ºã—ãŸãƒ˜ãƒƒãƒ€ãƒ¼
        headersPerFile = parsed.map(rows => extractHeader(rows, { trim: cfg.trim }));

        // ãƒ˜ãƒƒãƒ€ãƒ¼ä¸ä¸€è‡´ã‹åˆ¤å®šï¼ˆskipHeaderãŒOFFã®æ™‚ã®ã¿ï¼‰
        const headerCheck = (!cfg.skipHeader) && headersMismatch(headersPerFile);
        if (headerCheck){
          buildColumnMappingUI(headersPerFile, files.map(f=>f.name));
          colmapCard.style.display = '';
        } else {
          colmapCard.style.display = 'none';
          colmapContainer.innerHTML = '';
          mappingActive = false;
          columnMappings = {};
        }

        // éƒ¨åˆ†çš„æ¤œæŸ»ã®è¨­å®šUIï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚‹ã¨ãã®ã¿ï¼‰
        if (!cfg.skipHeader && headersPerFile.length >= 2 && headersPerFile[0].length > 0){
          buildPartialUI(headersPerFile, files.map(f=>f.name));
          partialCard.style.display = '';
        } else {
          partialCard.style.display = 'none';
          partialConfig.innerHTML = '';
        }

        // æ­£è¦åŒ–ï¼ˆå¿…è¦ãªã‚‰ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨ï¼‰
        const normalized = parsed.map((rows, i) => {
          const mapIdx = mappingActive ? (columnMappings[i] || null) : null;
          return normalizeRows(rows, cfg, mapIdx);
        });
        const report = compareMany(normalized, files.map(f=>f.name), cfg);
        renderReport(report);

      } catch (err){
        console.error(err);
        summary.innerHTML = `<span class="bad">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(String(err))}</span>`;
      }
    });

    exportBtn.addEventListener('click', ()=>{
      if (!lastReport) return;
      const csv = exportMismatchesCsv(lastReport);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mismatches.csv';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    });

    applyMappingBtn.addEventListener('click', ()=>{
      if (!Object.keys(columnMappings).length){
        alert('ã‚«ãƒ©ãƒ å¯¾å¿œãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      mappingActive = true;
      analyzeBtn.click();
    });

    runPartialBtn.addEventListener('click', ()=>{
      try {
        const cfg = { trim: partialTrim.checked, strict: partialStrict.checked };
        const setup = readPartialSelection();
        if (!setup){
          partialResult.innerHTML = '<span class="bad">éƒ¨åˆ†çš„æ¤œæŸ»ã®è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚</span>';
          return;
        }
        const result = runPartialCheck(setup, cfg);
        renderPartialResult(result);
      } catch (e){
        console.error(e);
        partialResult.innerHTML = `<span class="bad">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(String(e))}</span>`;
      }
    });

    // ---------- Parsing & Normalization ----------
    function parseCsvFile(file){
      return new Promise((resolve, reject)=>{
        Papa.parse(file, {
          skipEmptyLines: 'greedy',
          dynamicTyping: false,
          complete: (res)=> resolve(res.data),
          error: (err)=> reject(err)
        });
      });
    }

    function extractHeader(rows, {trim}){
      if (!rows || rows.length === 0) return [];
      const r0 = rows[0] || [];
      return r0.map(c => {
        let s = String(c ?? '');
        if (trim) s = s.trim();
        return s;
      });
    }

    function normalizeRows(rows, {skipHeader, trim}, reorderIndices=null){
      const out = [];
      const start = skipHeader ? 1 : 0;
      let minCols = Infinity, maxCols = 0;
      for (let i=start; i<rows.length; i++){
        let r = rows[i];
        if (!Array.isArray(r)) continue;
        let cells = r.map(c => {
          let s = String(c ?? '');
          if (trim) s = s.trim();
          return s;
        });
        if (Array.isArray(reorderIndices)){
          const reordered = reorderIndices.map(idx => idx >= 0 ? (cells[idx] ?? '') : '');
          cells = reordered;
        }
        minCols = Math.min(minCols, cells.length);
        maxCols = Math.max(maxCols, cells.length);
        out.push(cells);
      }
      if (minCols === Infinity){ minCols = 0; maxCols = 0; }
      return { rows: out, minCols, maxCols };
    }

    function rowKey(cells){
      return cells.join('\u241F');
    }

    function toFreqMap(rows){
      const m = new Map();
      for (const r of rows){
        const k = rowKey(r);
        m.set(k, (m.get(k)||0) + 1);
      }
      return m;
    }

    // ---------- Comparison & Report ----------
    function compareMany(normalizedArray, filenames, {multiset}){
      const files = normalizedArray.map((n, idx) => ({
        name: filenames[idx],
        rows: n.rows,
        minCols: n.minCols,
        maxCols: n.maxCols,
        totalRows: n.rows.length,
        freq: toFreqMap(n.rows)
      }));

      const sizeSummary = files.map(f=>({ name:f.name, rows:f.totalRows, minCols:f.minCols, maxCols:f.maxCols }));

      const allKeys = new Set();
      for (const f of files){ for (const k of f.freq.keys()) allKeys.add(k); }

      let fullyEqual = true;
      let commonCount = 0;
      const perFileUnmatched = files.map(()=>0);
      const mismatchRows = [];

      for (const k of allKeys){
        const counts = files.map(f => f.freq.get(k) || 0);
        const minCount = Math.min(...counts);
        const maxCount = Math.max(...counts);
        if (multiset){
          commonCount += minCount;
          counts.forEach((c, i)=>{ perFileUnmatched[i] += Math.max(0, c - minCount); });
          if (!(minCount === maxCount)) fullyEqual = false;
        } else {
          const present = counts.map(c=>c>0);
          const allHave = present.every(Boolean);
          if (allHave) commonCount += 1;
          counts.forEach((c, i)=>{ if (allHave) return; if (c>0) perFileUnmatched[i]+=1; });
          if (!allHave) fullyEqual = false;
        }
        const allEqualCounts = counts.every(c => c === counts[0]);
        if (!allEqualCounts){ mismatchRows.push({ key:k, counts, sample: k.split('\u241F') }); }
      }

      const rowsAllSame = files.every(f => f.totalRows === files[0].totalRows);
      const colsAllSame = files.every(f => f.maxCols === files[0].maxCols && f.minCols === files[0].minCols);
      if (fullyEqual){ if (!rowsAllSame) fullyEqual = false; }

      const unionSize = allKeys.size;

      return { config: { multiset }, files, sizeSummary, rowsAllSame, colsAllSame, fullyEqual, commonCount, unionSize, perFileUnmatched, mismatchRows };
    }

    function renderReport(report){
      lastReport = report;
      const { sizeSummary, rowsAllSame, colsAllSame, fullyEqual, commonCount, unionSize, perFileUnmatched, files, mismatchRows, config } = report;

      // ä¸ä¸€è‡´æ™‚ã«å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ©ãƒ ä¸€è¦§ã‚’æç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼æœ‰ã‚Šã®å ´åˆï¼‰
      const colLists = (headersPerFile && headersPerFile.length>0) ? `
        <details style="margin-top:8px">
          <summary>å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ©ãƒ ä¸€è¦§ã‚’è¡¨ç¤º</summary>
          <div class="grid-2" style="margin-top:8px">
            ${headersPerFile.map((h, i)=>`
              <div class="card" style="padding:10px">
                <div style="margin-bottom:6px"><b><code>${escapeHtml(files[i].name)}</code></b></div>
                <div class="muted">${(h||[]).map(x=>`<code>${escapeHtml(x)}</code>`).join(' , ') || '(ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—)'}</div>
              </div>
            `).join('')}
          </div>
        </details>` : '';

      const pills = [];
      pills.push(`<span class="pill">ãƒ¢ãƒ¼ãƒ‰: ${config.multiset ? 'å¤šé‡é›†åˆï¼ˆé‡è¤‡æ•°ã‚‚æ¯”è¼ƒï¼‰' : 'é›†åˆï¼ˆå­˜åœ¨ã®ã¿ï¼‰'}</span>`);
      pills.push(`<span class="pill">ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${files.length}</span>`);
      pills.push(`<span class="pill">å…±é€šè¡Œæ•°: <b>${fmt(commonCount)}</b></span>`);
      if (!config.multiset) pills.push(`<span class="pill">è¡Œï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰å…¨ä½“: <b>${fmt(unionSize)}</b></span>`);

      const sizeTable = `
        <table>
          <thead><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«</th><th>è¡Œæ•°</th><th>åˆ—æ•°ï¼ˆmin / maxï¼‰</th><th>ä¸ä¸€è‡´è¡Œï¼ˆä½™å‰°ï¼‰</th></tr></thead>
          <tbody>
            ${sizeSummary.map((s, i)=>`
              <tr>
                <td><code>${escapeHtml(s.name)}</code></td>
                <td>${fmt(s.rows)}</td>
                <td>${s.minCols} / ${s.maxCols}</td>
                <td>${fmt(perFileUnmatched[i])}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;

      const status = fullyEqual
        ? `<div class="good">âœ… å®Œå…¨ä¸€è‡´ï¼šå…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®<b>å…¨è¡Œï¼ˆ${config.multiset?'é‡è¤‡æ•°ã‚‚æ¯”è¼ƒ':''}</b>ï¼‰ãŒä¸€è‡´ã—ã€è¡Œæ•°ã‚‚ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚</div>`
        : `<div class="bad">âŒ å®Œå…¨ä¸€è‡´ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;

      const sizeHints = `
        <div style="margin-top:6px" class="muted">
          <span class="pill ${rowsAllSame?'good':'bad'}">è¡Œæ•° ${rowsAllSame?'ä¸€è‡´':'ä¸ä¸€è‡´'}</span>
          <span class="pill ${colsAllSame?'good':'warn'}">åˆ—æ•°ï¼ˆmin/maxï¼‰ ${colsAllSame?'ä¸€è‡´':'å·®ã‚ã‚Šï¼ˆå‚è€ƒï¼‰'}</span>
        </div>`;

      summary.innerHTML = `
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">${pills.join('')}</div>
        ${status}
        ${sizeHints}
        <div style="margin-top:10px">${sizeTable}</div>
        ${fullyEqual ? '' : colLists}
        <div style="margin-top:10px" class="muted">éƒ¨åˆ†ä¸€è‡´ã®é›†è¨ˆï¼š<b>å…±é€šè¡Œæ•° = ${fmt(commonCount)}</b>ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã€Œä¸ä¸€è‡´è¡Œï¼ˆä½™å‰°ï¼‰ã€ã¯è¡¨ã®å³åˆ—ã‚’ã”å‚ç…§ãã ã•ã„ã€‚</div>
      `;

      if (mismatchRows.length === 0){
        detailsWrap.innerHTML = `<div class="good">ä¸ä¸€è‡´è¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        exportBtn.disabled = true;
        return;
      }

      const header = `<thead><tr><th>è¡Œï¼ˆã‚»ãƒ«ä¸€è¦§ï¼‰</th>${files.map(f=>`<th>å‡ºç¾å›æ•°<br><code>${escapeHtml(f.name)}</code></th>`).join('')}</tr></thead>`;
      const body = mismatchRows.map(rec => {
        const rowHtml = `<code>${escapeHtml(rec.sample.join(' | '))}</code>`;
        const countsHtml = rec.counts.map(c => `<td>${fmt(c)}</td>`).join('');
        return `<tr><td>${rowHtml}</td>${countsHtml}</tr>`;
      }).join('');

      detailsWrap.innerHTML = `<div style="overflow:auto; max-height: 560px; border:1px solid #1f2937; border-radius: 10px;"><table>${header}<tbody>${body}</tbody></table></div>`;
      exportBtn.disabled = false;
    }

    function exportMismatchesCsv(report){
      const headers = ['cell_0','cell_1','cell_2','...'].concat(report.files.map(f=>`count__${f.name}`));
      const lines = [];
      lines.push(headers.map(csvEscape).join(','));
      for (const rec of report.mismatchRows){
        const row = rec.sample.map(csvEscape);
        const counts = rec.counts.map(n=>String(n));
        lines.push(row.concat(counts).join(','));
      }
      return lines.join('\n');
    }

    // ---------- Header mismatch helpers ----------
    function headersMismatch(allHeaders){
      if (allHeaders.length < 2) return false;
      const ref = JSON.stringify(allHeaders[0] || []);
      for (let i=1;i<allHeaders.length;i++){
        if (JSON.stringify(allHeaders[i] || []) !== ref) return true;
      }
      return false;
    }

    function buildColumnMappingUI(allHeaders, names){
      colmapContainer.innerHTML = '';
      columnMappings = {};
      mappingActive = false;
      if (skipHeader.checked) return; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã‚ãªã„è¨­å®šãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

      const canon = allHeaders[0] || [];
      const info = document.createElement('div');
      info.className = 'muted';
      info.innerHTML = `åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«: <code>${escapeHtml(names[0])}</code> ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åŸºæº–ã«ã€ä»–ãƒ•ã‚¡ã‚¤ãƒ«ã®å¯¾å¿œã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
      colmapContainer.appendChild(info);

      for (let i=1;i<allHeaders.length;i++){
        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.style.padding = '12px';
        const title = document.createElement('div');
        title.innerHTML = `<b>å¯¾å¿œæŒ‡å®š: <code>${escapeHtml(names[i])}</code></b>`;
        wrap.appendChild(title);

        const tbl = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>åŸºæº–ã‚«ãƒ©ãƒ å</th><th>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ©ãƒ </th></tr>';
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');

        const options = (allHeaders[i] || []).map((h, idx)=>({label:h, idx}))
          .concat([{label:'(ç©ºæ¬„ã«ã™ã‚‹)', idx:-1}]);

        const mappingIdx = [];
        canon.forEach((cname, cIdx)=>{
          const tr = document.createElement('tr');
          const tdL = document.createElement('td');
          tdL.innerHTML = `<code>${escapeHtml(cname)}</code>`;
          const tdR = document.createElement('td');
          const sel = document.createElement('select');
          sel.className = 'btn';
          options.forEach(opt => {
            const o = document.createElement('option');
            o.value = String(opt.idx);
            o.textContent = opt.label;

            // ğŸ¨ â† ã“ã“ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å€‹åˆ¥æŒ‡å®š
            o.style.backgroundColor = '#0f172a';
            o.style.color = '#e5e7eb';

            sel.appendChild(o);
          });
          // æ—¢å®šï¼šåŒåãŒã‚ã‚Œã°åŒåã€ãªã‘ã‚Œã°åŒã˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãã‚Œã‚‚ãªã‘ã‚Œã°-1
          let pre = (allHeaders[i] || []).findIndex(h=>h===cname);
          if (pre === -1) pre = cIdx < (allHeaders[i]||[]).length ? cIdx : -1;
          sel.value = String(pre);
          mappingIdx[cIdx] = pre;
          sel.addEventListener('change', ()=>{
            mappingIdx[cIdx] = parseInt(sel.value, 10);
            columnMappings[i] = mappingIdx.slice();
          });
          tdR.appendChild(sel);
          tr.appendChild(tdL); tr.appendChild(tdR); tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        wrap.appendChild(tbl);
        colmapContainer.appendChild(wrap);
        columnMappings[i] = mappingIdx.slice();
      }
    }

    // ---------- Partial check UI & logic ----------
    function buildPartialUI(allHeaders, names){
      partialConfig.innerHTML = '';
      // å…ˆé ­ï¼ˆåŸºæº–ï¼‰
      const ref = document.createElement('div');
      ref.className = 'card';
      ref.style.padding = '12px';
      ref.innerHTML = `<div style="margin-bottom:6px"><b>åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«</b>: <code>${escapeHtml(names[0])}</code></div>`;
      const refKeySel = makeSelect(allHeaders[0], 'ã‚­ãƒ¼åˆ—ï¼ˆä¾‹: indexï¼‰');
      const refValSel = makeSelect(allHeaders[0], 'æ¯”è¼ƒåˆ—ï¼ˆä¾‹: raw_votesï¼‰');
      ref.appendChild(refKeySel.wrap);
      ref.appendChild(refValSel.wrap);
      ref.dataset.keySelId = refKeySel.select.id;
      ref.dataset.valSelId = refValSel.select.id;
      partialConfig.appendChild(ref);

      // åˆæœŸæ¨å¥¨ï¼ˆindex/raw_votesãŒã‚ã‚Œã°é¸æŠï¼‰
      const refKeyIdx = (allHeaders[0]||[]).findIndex(h=>h==='index');
      if (refKeyIdx >= 0) refKeySel.select.value = String(refKeyIdx);
      const refValIdx = (allHeaders[0]||[]).findIndex(h=>h==='raw_votes');
      if (refValIdx >= 0) refValSel.select.value = String(refValIdx);

      // ä»–ãƒ•ã‚¡ã‚¤ãƒ«
      for (let i=1;i<allHeaders.length;i++){
        const blk = document.createElement('div');
        blk.className = 'card';
        blk.style.padding = '12px';
        blk.innerHTML = `<div style="margin-bottom:6px"><b>æ¯”è¼ƒå¯¾è±¡</b>: <code>${escapeHtml(names[i])}</code></div>`;
        const keySel = makeSelect(allHeaders[i], 'ã‚­ãƒ¼åˆ—');
        const valSel = makeSelect(allHeaders[i], 'æ¯”è¼ƒåˆ—');

        // åˆæœŸå€¤ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ã‚¯ã‚¹
        const idxCand = ['index','id','Idx','ID'];
        const rk = (allHeaders[i]||[]).findIndex(h=> h==='index');
        if (rk>=0) keySel.select.value = String(rk); else {
          const k2 = (allHeaders[i]||[]).findIndex(h=> idxCand.includes(h));
          if (k2>=0) keySel.select.value = String(k2);
        }
        const rv = (allHeaders[i]||[]).findIndex(h=> h==='votes' || h==='raw_votes');
        if (rv>=0) valSel.select.value = String(rv);

        blk.appendChild(keySel.wrap);
        blk.appendChild(valSel.wrap);
        blk.dataset.keySelId = keySel.select.id;
        blk.dataset.valSelId = valSel.select.id;
        blk.dataset.fileIndex = String(i);
        partialConfig.appendChild(blk);
      }
    }

    function makeSelect(options, label){
      const id = 'sel_' + Math.random().toString(36).slice(2);
      const wrap = document.createElement('div');
      wrap.className = 'control';
      const lab = document.createElement('label');
      lab.textContent = label + 'ï¼š';
      lab.style.minWidth = '160px';
      const sel = document.createElement('select');
      sel.className = 'btn'; sel.id = id;
      (options||[]).forEach((h, idx)=>{
        const o = document.createElement('option');
        o.value = String(idx);
        o.textContent = h;
        sel.appendChild(o);
      });
      wrap.appendChild(lab); wrap.appendChild(sel);
      return {wrap, select: sel};
    }

    function readPartialSelection(){
      if (skipHeader.checked) return null;
      if (headersPerFile.length < 2) return null;
      const blocks = Array.from(partialConfig.children);
      if (blocks.length < 2) return null;
      const refBlk = blocks[0];
      const refKeyIdx = parseInt(document.getElementById(refBlk.dataset.keySelId).value, 10);
      const refValIdx = parseInt(document.getElementById(refBlk.dataset.valSelId).value, 10);
      const targets = [];
      for (let i=1;i<blocks.length;i++){
        const b = blocks[i];
        const keyIdx = parseInt(document.getElementById(b.dataset.keySelId).value, 10);
        const valIdx = parseInt(document.getElementById(b.dataset.valSelId).value, 10);
        const fileIndex = parseInt(b.dataset.fileIndex, 10);
        targets.push({ fileIndex, keyIdx, valIdx });
      }
      return { ref: { fileIndex:0, keyIdx:refKeyIdx, valIdx:refValIdx }, targets };
    }

    function runPartialCheck(setup, {trim, strict}){
      // å‚ç…§ãƒãƒƒãƒ—
      const refRows = rawRowsPerFile[setup.ref.fileIndex] || [];
      const refMap = new Map();
      for (let i=1;i<refRows.length;i++){
        const r = refRows[i]; if (!Array.isArray(r)) continue;
        const k = norm(String(r[setup.ref.keyIdx] ?? ''), trim);
        const v = norm(String(r[setup.ref.valIdx] ?? ''), trim);
        if (!refMap.has(k)) refMap.set(k, v);
      }
      const out = [];
      for (const t of setup.targets){
        const rows = rawRowsPerFile[t.fileIndex] || [];
        let matched=0, mismatched=0, missing=0, extra=0;
        const mismatches = [];
        const seenKeys = new Set();
        for (let i=1;i<rows.length;i++){
          const r = rows[i]; if (!Array.isArray(r)) continue;
          const k = norm(String(r[t.keyIdx] ?? ''), trim);
          const v = norm(String(r[t.valIdx] ?? ''), trim);
          seenKeys.add(k);
          if (!refMap.has(k)){
            extra++; // ç›¸æ‰‹ã«ã—ã‹ãªã„ã‚­ãƒ¼
            mismatches.push({ key:k, ref:'(ãªã—)', other:v });
          } else {
            const rv = refMap.get(k);
            const eq = strict ? v === rv : v == rv;
            if (eq) matched++; else { mismatched++; mismatches.push({ key:k, ref:rv, other:v }); }
          }
        }
        // å‚ç…§å´ã«ã‚ã‚‹ãŒç›¸æ‰‹ã«ãªã„ã‚­ãƒ¼
        for (const k of refMap.keys()){
          if (!seenKeys.has(k)){
            missing++;
            mismatches.push({ key:k, ref:refMap.get(k), other:'(ãªã—)' });
          }
        }
        out.push({ fileIndex:t.fileIndex, matched, mismatched, missing, extra, mismatches });
      }
      return out;
    }

    function renderPartialResult(results){
      const names = files.map(f=>f.name);
      const refName = names[0];
      const header = `
        <div class="pill">åŸºæº–: <code>${escapeHtml(refName)}</code></div>
        <div class="muted" style="margin-top:6px">ä¸€è‡´=ã‚­ãƒ¼ãŒã‚ã‚Šå€¤ã‚‚ä¸€è‡´ / ä¸ä¸€è‡´=ã‚­ãƒ¼ã¯ã‚ã‚‹ãŒå€¤ãŒç•°ãªã‚‹ / missing=åŸºæº–ã«ã®ã¿å­˜åœ¨ / extra=æ¯”è¼ƒå´ã«ã®ã¿å­˜åœ¨</div>
      `;
      const tables = results.map(r=>{
        const fname = names[r.fileIndex];
        const sum = `<div style="margin:6px 0" class="muted">ä¸€è‡´: <b>${fmt(r.matched)}</b> / ä¸ä¸€è‡´: <b>${fmt(r.mismatched)}</b> / missing: <b>${fmt(r.missing)}</b> / extra: <b>${fmt(r.extra)}</b></div>`;
        const rows = r.mismatches.map(x=>`<tr><td><code>${escapeHtml(x.key)}</code></td><td><code>${escapeHtml(x.ref)}</code></td><td><code>${escapeHtml(x.other)}</code></td></tr>`).join('');
        const table = `
          <div class="card" style="padding:12px; margin-top:8px">
            <div><b>æ¯”è¼ƒå¯¾è±¡:</b> <code>${escapeHtml(fname)}</code></div>
            ${sum}
            <div style="overflow:auto; max-height: 420px; border:1px solid #1f2937; border-radius: 10px;">
              <table>
                <thead><tr><th>key</th><th>${escapeHtml(refName)} å€¤</th><th>${escapeHtml(fname)} å€¤</th></tr></thead>
                <tbody>${rows || '<tr><td colspan="3" class="muted">å·®åˆ†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>'}</tbody>
              </table>
            </div>
          </div>`;
        return table;
      }).join('');
      partialResult.innerHTML = header + tables;
    }

    // ---------- Init ----------
    onFilesChanged();
  </script>
</body>
</html>